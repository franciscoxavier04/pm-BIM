name: downstream-ci
on:
  push:
    branches:
      - dev
      - 'release/**'
    paths-ignore:
      - 'docs/**'
      - 'help/**'
  # We run this in the less privileged mode to allow external PRs to use this workflow.
  # This means the workflow will be executed on the base branch, making sure only our own workflow logic is used.
  pull_request_target:
    types: [opened, reopened, synchronize]
    branches:
      - dev
      - 'release/**'
    paths-ignore:
      - 'docs/**'
      - 'help/**'
      - 'packaging/**'
      - '.pkgr.yml'

permissions:
  contents: read

jobs:
  trigger_saas_tests:
    permissions:
      contents: none
    if: github.repository == 'opf/openproject'
    name: SaaS tests
    runs-on: ubuntu-latest
    steps:
      - name: Trigger SaaS Tests
        env:
          TOKEN: ${{ secrets.OPENPROJECT_CI_TOKEN }}
          REPOSITORY: opf/saas-openproject
          WORKFLOW_ID: test-saas.yml
        # ref:
        #   * on push this will be `dev` or a specific release branch (e.g. release/16.1) - there is always a matching branch for that downstream
        #   * on pull_request we use the PR branch's base (e.g. dev or a release branch) to match the above
        # core_ref:
        #   * the name of the core branch that has to be checked out downstream to run the tests
        #   * that is either dev, release/16.1 (for instance), or the pull request's branch name
        run: |
          echo Triggering downstream workflow
          REF=''
          CORE_REF=''

          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo the workflow was triggered by a pull request targetting the dev or a release branch
            REF="${{ github.base_ref }}"
            CORE_REF="${{ github.event.pull_request.head.ref }}"
          else
            echo the workflow was triggered by a push to the dev or a release branch
            REF="${{ github.ref_name }}"
            CORE_REF="$REF"
          fi

          if [[ ! "$REF" =~ dev|release/.+ ]]; then
            echo "Base branch is not dev or release branch. Cannot check downstream tests."
            exit 0
          fi

          curl -i --fail-with-body -H"authorization: Bearer $TOKEN" \
            -XPOST -H"Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/$REPOSITORY/actions/workflows/$WORKFLOW_ID/dispatches \
            -d '{"ref": "$REF", "inputs": { "core_ref" : "$CORE_REF" }}'
